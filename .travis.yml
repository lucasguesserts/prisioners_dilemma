language: cpp
compiler: gcc
dist: bionic

if: branch = master OR branch = develop

git:
    quiet: true

before_install:
    - sudo apt update -qq > /dev/null

install: 
    - sudo apt install valgrind -qq > /dev/null
    - sudo apt install gcovr -qq > /dev/null
    - ./install_catch2.sh > /dev/null 2>&1
    - ./install_hdf5.sh > /dev/null 2>&1

script:
    - mkdir build
    - cd build
    - cmake ..
    - make -j `nproc --all`
    - make test
    - cd bin
    - for TEST in `ls`;
      do
          echo -e "\n\n$TEST\n----------------------------------------\n";
          valgrind --leak-check=yes --track-origins=yes --error-exitcode=1 ./$TEST;
      done

after_success:
    - bash <(curl -s https://codecov.io/bash)
